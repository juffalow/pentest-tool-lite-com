FROM node:14-alpine as build

RUN mkdir /home/node/pentest-tool-lite-com-frontend/ && chown -R node:node /home/node/pentest-tool-lite-com-frontend
WORKDIR /home/node/pentest-tool-lite-com-frontend
COPY --chown=node:node . .
RUN yarn install --frozen-lockfile && yarn build

FROM nginx:stable-alpine

COPY --from=build /home/node/pentest-tool-lite-com-frontend/build /usr/share/nginx/html
RUN rm /etc/nginx/conf.d/default.conf

RUN echo 'server {' >> /etc/nginx/conf.d/default.conf
RUN echo '  listen 80;' >> /etc/nginx/conf.d/default.conf
RUN echo '  location / {' >> /etc/nginx/conf.d/default.conf
RUN echo '    root   /usr/share/nginx/html;' >> /etc/nginx/conf.d/default.conf
RUN echo '    index  index.html index.htm;' >> /etc/nginx/conf.d/default.conf
RUN echo '    try_files $uri $uri/ /index.html;' >> /etc/nginx/conf.d/default.conf
RUN echo '  }' >> /etc/nginx/conf.d/default.conf
RUN echo '  error_page   500 502 503 504  /50x.html;' >> /etc/nginx/conf.d/default.conf
RUN echo '  location = /50x.html {' >> /etc/nginx/conf.d/default.conf
RUN echo '    root   /usr/share/nginx/html;' >> /etc/nginx/conf.d/default.conf
RUN echo '  }' >> /etc/nginx/conf.d/default.conf
RUN echo '}' >> /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
