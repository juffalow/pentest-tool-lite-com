import React, { useState, useEffect } from 'react';
import Container from 'react-bootstrap/Container';
import Row from 'react-bootstrap/Row';
import Col from 'react-bootstrap/Col';
import ButtonGroup from 'react-bootstrap/ButtonGroup';
import ToggleButton from 'react-bootstrap/ToggleButton';
import Result from './report/Result';
import SEO from '../components/SEO';
import { getResult } from '../api/services';

const Report: React.FC = ({ match }: any) => {
  const [ test, setTest ] = useState<any>(null);
  const [ statusFilter, setStatusFilter ] = useState<string[]>([]);

  const toggleStatusFilter = (event: any): void => {
    const status: string = event.target.value;
    if (statusFilter.includes(status)) {
      setStatusFilter(statusFilter.filter((value: string) => value !== status));
    } else {
      setStatusFilter([...statusFilter, status]);
    }
  }; 

  useEffect(() => {
    getResult(match.params.id).then((response: any) => setTest(response));
  }, [ match.params.id ]);

  useEffect(() => {
    const interval = setInterval(() => {
      getResult(match.params.id).then((response: any) => {
        setTest(response);
        if ('isDone' in response && response.isDone === true) {
          clearInterval(interval);
        }
      });
    }, 5000);

    return () => clearInterval(interval);
  }, [ match.params.id ])

  return (
    <SEO title="Report" description="">
      <Container>
        <Row>
          <Col>
            <h1>Report</h1>
            {
              test !== null ? (
                <>
                  <p><b>URL</b>: <a href={test.url} target="_blank" rel="noopener noreferrer">{test.url}</a></p>
                  <p><b>Requested at</b>: {test.createdAt}</p>
                  <p><b>Status</b>: {test.status}</p>
                  <Row xs="auto" style={{paddingTop:'1rem'}}>
                    <ButtonGroup>
                      <ToggleButton
                        id="success"
                        type="checkbox"
                        variant="outline-success"
                        value="SUCCESS"
                        checked={statusFilter.includes("SUCCESS")}
                        onChange={toggleStatusFilter}
                      >
                        {test.successCount} Success
                      </ToggleButton>
                      <ToggleButton
                        id="warning"
                        type="checkbox"
                        variant="outline-warning"
                        value="WARNING"
                        checked={statusFilter.includes("WARNING")}
                        onChange={toggleStatusFilter}
                      >
                        {test.warningCount} Warning
                      </ToggleButton>
                      <ToggleButton
                        id="critical"
                        type="checkbox"
                        variant="outline-danger"
                        value="ERROR"
                        checked={statusFilter.includes("ERROR")}
                        onChange={toggleStatusFilter}
                      >
                        {test.errorCount} Critical
                      </ToggleButton>
                    </ButtonGroup>
                  </Row>
                </>
              ) : null
            }
          </Col>
        </Row>
        {
          test !== null && test.isDone === true && test.status !== 'error' ? (
            <Row className="mt-4">
              <Col>
                <h2>Security</h2>
                <Result tests={test.result.security.results.filter((result: unknown) => result !== null)} level={1} filteredStatuses={statusFilter} />
              </Col>
            </Row>
          ) : null
        }
        {
          test !== null && test.isDone === true && test.status !== 'error' ? (
            <Row className="mt-4">
              <Col>
                <h2>HTML</h2>
                <Result tests={test.result.html.results.filter((result: unknown) => result !== null)} level={1} filteredStatuses={statusFilter} />
              </Col>
            </Row>
          ) : null
        }
        {
          test !== null && test.isDone === true && test.status !== 'error' ? (
            <Row className="mt-4">
              <Col>
                <h2>SEO</h2>
                <Result tests={test.result.seo.results.filter((result: unknown) => result !== null)} level={1} filteredStatuses={statusFilter} />
              </Col>
            </Row>
          ) : null
        }
        {
          test !== null && test.isDone === true && test.status !== 'error' && test.result.wordpress.status !== 'SUCCESS' ? (
            <Row className="mt-4">
              <Col>
                <h2>WordPress</h2>
                <Result tests={test.result.wordpress.results.filter((result: unknown) => result !== null)} level={1} filteredStatuses={statusFilter} />
              </Col>
            </Row>
          ) : null
        }
      </Container>
    </SEO>
  );
}

export default Report;
