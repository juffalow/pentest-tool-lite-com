import React, { useState, useEffect } from 'react';
import Container from 'react-bootstrap/Container';
import Row from 'react-bootstrap/Row';
import Col from 'react-bootstrap/Col';
import Badge from 'react-bootstrap/Badge';
import Result from './report/Result';
import SEO from '../components/SEO';
import { getResult } from '../api/services';

const Report: React.FC = ({ match }: any) => {
  const [ test, setTest ] = useState<any>(null);

  useEffect(() => {
    getResult(match.params.id).then((response: any) => setTest(response));
  }, [ match.params.id ]);

  useEffect(() => {
    const interval = setInterval(() => {
      getResult(match.params.id).then((response: any) => {
        setTest(response);
        if ('isDone' in response && response.isDone === true) {
          clearInterval(interval);
        }
      });
    }, 5000);

    return () => clearInterval(interval);
  }, [ match.params.id ])

  return (
    <SEO title="Report" description="">
      <Container>
        <Row>
          <Col>
            <h1>Report</h1>
            {
              test !== null ? (
                <>
                  <p><b>URL</b>: <a href={test.url} target="_blank" rel="noopener noreferrer">{test.url}</a></p>
                  <p><b>Requested at</b>: {test.createdAt}</p>
                  <p><b>Status</b>: {test.status}</p>
                  <Row xs="auto" style={{paddingTop:'1rem'}}>
                    <Col><h4><Badge bg="success">{test.successCount} Success</Badge></h4></Col>
                    <Col><h4><Badge bg="warning">{test.warningCount} Warning</Badge></h4></Col>
                    <Col><h4><Badge bg="danger">{test.errorCount} Critical</Badge></h4></Col>
                  </Row>
                </>
              ) : null
            }
          </Col>
        </Row>
        {
          test !== null && test.isDone === true && test.status !== 'error' ? (
            <Row className="mt-4">
              <Col>
                <h2>Security</h2>
                <Result tests={test.result.security.results.filter((result: unknown) => result !== null)} level={1} />
              </Col>
            </Row>
          ) : null
        }
        {
          test !== null && test.isDone === true && test.status !== 'error' ? (
            <Row className="mt-4">
              <Col>
                <h2>HTML</h2>
                <Result tests={test.result.html.results.filter((result: unknown) => result !== null)} level={1} />
              </Col>
            </Row>
          ) : null
        }
        {
          test !== null && test.isDone === true && test.status !== 'error' && test.result.wordpress.status !== 'SUCCESS' ? (
            <Row className="mt-4">
              <Col>
                <h2>WordPress</h2>
                <Result tests={test.result.wordpress.results.filter((result: unknown) => result !== null)} level={1} />
              </Col>
            </Row>
          ) : null
        }
      </Container>
    </SEO>
  );
}

export default Report;
