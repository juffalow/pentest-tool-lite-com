import express from 'express';
import Pentest from 'pentest-tool-lite/src/Pentest';
import database from '../database';

const router = express.Router();

router.post('/', async (req, res) => {
  const body = req.body;

  if (!('url' in body)) {
    return res.json({
      error: 'Field url is missing!',
    });
  }

  const id = await database.insert({
    url: body.url,
  })
    .into('test')
    .then(ids => {
      return ids[0];
    });

  const test = await database.select().from('test').where('id', id).first();

  res.json({ data: { test } });
});

router.get('/run/:id', async (req, res) => {
  const test = await database.select().from('test').where('id', req.params.id).first();

  const pentest = new Pentest();
  const result = await pentest.run(test.url);

  await database.table('test').update({ result: JSON.stringify(result), status: 'done' }).where('id', req.params.id);

  res.json({ data: result });
});

router.get('/:id', async (req, res) => {
  const test = await database.select().from('test').where('id', req.params.id).first();

  res.json({ data: { test } });
});

export default router;
