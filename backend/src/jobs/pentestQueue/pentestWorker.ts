import Pentest from 'pentest-tool-lite/src/Pentest';
import database from '../../database';
import logger from '../../logger';

const worker = async (job): Promise<{isDone: boolean}> => {
  await database.table('test').update({ status: 'running' }).where('id', job.data.id);

  const test = await database.select().from('test').where('id', job.data.id).first();

  logger.info('Starting new pentest!', { id: test.id, url: test.url });

  try {
    const pentest = new Pentest();
    const result = await pentest.run(test.url);
  
    await database.table('test').update({ result: JSON.stringify(result), status: 'done', isDone: '1' }).where('id', job.data.id);
  } catch (error) {
    logger.error('Pentest run failed!', { message: error.message, stack: error.stack });
    await database.table('test').update({ status: 'error', isDone: '1' }).where('id', job.data.id);
  }

  return { isDone: true };
};

export default worker;
